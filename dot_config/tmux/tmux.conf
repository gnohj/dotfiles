# ████████╗███╗   ███╗██╗   ██╗██╗  ██╗
# ╚══██╔══╝████╗ ████║██║   ██║╚██╗██╔╝
#    ██║   ██╔████╔██║██║   ██║ ╚███╔╝
#    ██║   ██║╚██╔╝██║██║   ██║ ██╔██╗
#    ██║   ██║ ╚═╝ ██║╚██████╔╝██╔╝ ██╗
#    ╚═╝   ╚═╝     ╚═╝ ╚═════╝ ╚═╝  ╚═╝
#
# Terminal multiplexer
# https://github.com/tmux/tmux

source "$HOME/.config/colorscheme/active/active-colorscheme.sh"

# Set PATH for tmux to include Homebrew and Nix
# This ensures commands like brew, thefuck, etc. are available in new panes
set-environment -g PATH "/opt/homebrew/bin:/opt/homebrew/sbin:/run/current-system/sw/bin:$PATH"

set -sg terminal-overrides ",*:RGB"

set -g default-terminal "${TERM}"

# default sets bg to transparent
set -g status-style 'bg=default'

# Update status bar every 1 second to reflect changes in system info and window names
set -g status-interval 1

set -g pane-border-lines single

# Indicate active pane by colouring only half of the border in windows with 
# exactly two panes, by displaying arrow markers, by drawing both or neither.
# [off | colour | arrows | both]
set -g pane-border-indicators both

set-option -g history-limit 10000

set -g set-clipboard on
set -gq allow-passthrough on # Enables passthrough mode in Tmux 3.3+ for rendering images via nvim - image.nvim
set -g visual-activity off # Automatically show/hide images when switching tabs (windows) per session

set-window-option -g xterm-keys on

set -g prefix C-a
unbind C-b
bind-key C-a send-prefix

unbind %
# bind | split-window -h 
unbind '"'
# bind - split-window -v
# Open panes in cwd
bind '-' split-window -v -c "#{pane_current_path}"
bind | split-window -h -c "#{pane_current_path}"

# Create new windows with fish emoji for shell
bind c new-window -n "🐠" -c "#{pane_current_path}"

# Set initial window name on session creation based on context
# For config session and others with nvim, use pen emoji
set-hook -g session-created 'run-shell "sleep 0.1 && bash ~/.config/tmux/initial-window-setup.sh"'
set-hook -g client-attached 'run-shell "bash ~/.config/tmux/initial-window-setup.sh"'

unbind r
bind r source-file ~/.config/tmux/tmux.conf \; source-file ~/.config/tmux/tmux-colors.conf \; display-message "Config reloaded"

bind j resize-pane -D 25
bind k resize-pane -U 25
bind l resize-pane -R 25
bind h resize-pane -L 25

bind -r m resize-pane -Z

set -g mouse on

set-window-option -g mode-keys vi

bind-key -T copy-mode-vi 'v' send -X begin-selection # start selecting text with "v"
bind-key -T copy-mode-vi 'y' send -X copy-selection # copy text with "y"
bind-key -T copy-mode-vi 'q' send -X copy-selection # copy text with "y"

unbind -T copy-mode-vi MouseDragEnd1Pane # don't exit copy mode when dragging with mouseT

bind-key x kill-pane # skip "kill-pane 1? (y/n)" prompt
set -g detach-on-destroy off  # don't exit from tmux when closing a session

# other bindings
colorscheme_selector="~/.config/colorscheme/colorscheme-selector.sh"
unbind 9
bind-key -r 9 run-shell "tmux neww -n '🎨 Theme' $colorscheme_selector"

run-shell 'tmux set -g popup-border-style "fg=$gnohj_color24"'

bind-key T run-shell "~/.config/tmux/toggle-terminal-transparency.sh"

# remove delay for exiting insert mode with ESC in Neovim
set -sg escape-time 10

# move tmux bar to top instead of bottom
set -g status-position top

# renumber windows if you close one
set -g renumber-windows on

setenv -g TMUX_PLUGIN_MANAGER_PATH "$HOME/.config/tmux/plugins/"
set -g @tpm_plugins '             \
  tmux-plugins/tpm                \
  christoomey/vim-tmux-navigator  \
  Morantron/tmux-fingers#master   \
'

# Disable tmux-fingers wizard/welcome message
set -g @fingers-skip-wizard 1

# Match file names (anything after the last space)
set -g @fingers-pattern-0 '[a-zA-Z0-9][a-zA-Z0-9._-]*\.(sh|conf|md|json|yml|yaml|js|ts|py)$'

# Match numbers (file sizes, etc)  
set -g @fingers-pattern-1 '[0-9]+\.[0-9]+[a-zA-Z]+'

# Match anything that looks like a filename
set -g @fingers-pattern-3 '[a-zA-Z0-9_-]+\.[a-zA-Z]{2,4}'


# Zero-out escape time delay for quicker response
set -s escape-time 3

bind s choose-tree -Zs -O time -F "#{session_windows}"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'

# Generate and source tmux colors from active colorscheme
run-shell '~/.config/tmux/generate-tmux-colors.sh'
source-file ~/.config/tmux/tmux-colors.conf

# Use emoji based on the running command - configured from external file
source-file ~/.config/tmux/window-emojis.conf
set -g window-status-separator ' '


set-option -g focus-events on
#
# # When a pane gains focus, command it to have a transparent background
set-hook -g pane-focus-in 'select-pane -P "bg=default"'
#
# # When a pane loses focus, command it to have a solid black background
set-hook -g pane-focus-out 'select-pane -P "bg=$gnohj_color10"'

# Add empty line after status bar for spacing (must be after TPM)
set -g status 2
set -g status-format[1] ''


# Use the user's default shell (from $SHELL environment variable)
# This allows tmux to respect whatever shell you're using (zsh, fish, etc.)
# Use login shell to ensure PATH is properly initialized (sources .zshrc)
set -g default-shell $SHELL
set -g default-command "${SHELL} -l"
